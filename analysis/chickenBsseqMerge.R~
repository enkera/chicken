#!/usr/bin/Rscript
##All alignment data lives here 
datdir="/atium/Data/NGS/Aligned/170120_chicken"

##root for processing
procroot="/home/isac/Dropbox/Data/Genetics/MethSeq/170120_chicken"
##Plots go here:
plotdir=file.path(procroot,"plots")

##Load libraries and sources
require(Biostrings)
require(plyr)
require(ggplot2)
require(bsseq)
require(reshape)
require(GenomicRanges)

##read in the data info
if (TRUE) {
    bismark.samp.info=read.csv(file=file.path(procroot,"infotable.csv"),row.names=1,colClasses="character")
    bismark.samp.info$filepath=file.path(datdir, bismark.samp.info$sample, paste0(bismark.samp.info$sample, ".cyto.txt.gz"))
}
##merging the bsobjects
if (TRUE) {
    ind = 1
    load(file.path(datdir,paste0("bsobject",bismark.samp.info$sample[ind],".rda")))
    colnames(bismark)=colnames(BS.fit.large)=colnames(BS.fit.small)=bismark.samp.info$label[ind]
    bismark.tot=bismark
    BS.fit.large.tot=BS.fit.large
    BS.fit.small.tot=BS.fit.small
    for (ind in seq(dim(bismark.samp.info)[1])[-1]){
        load(file.path(datdir,paste0("bsobject",bismark.samp.info$sample[ind],".rda")))
        colnames(bismark)=colnames(BS.fit.large)=colnames(BS.fit.small)=bismark.samp.info$label[ind]
        bismark.tot=c(bismark.tot,bismark)
        BS.fit.large.tot=c(BS.fit.large.tot,BS.fit.large)
        BS.fit.small.tot=c(BS.fit.small.tot,BS.fit.small)        
    }
    ##compressing the list into one BSseq object
    bismark=combineList(bismark.tot)
    BS.fit.large=combineList(BS.fit.large.tot)
    BS.fit.small=combineList(BS.fit.small.tot)
    #transferring bismark.samp.info into the pData
    for (x in colnames(bismark.samp.info)) bismark[[x]]=BS.fit.large[[x]]=BS.fit.small[[x]]=bismark.samp.info[,x]
    save(list=c("bismark","BS.fit.large","BS.fit.small"),file=file.path(datdir,"bsobject.rda"))
}    
