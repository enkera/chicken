#!/usr/bin/Rscript
datdir="/home/isac/Dropbox/Data/Genetics/MethSeq/150415_chicken/QC/zips/extracted/data"

##root for processing
procroot="/home/isac/Dropbox/Data/Genetics/MethSeq/170120_chicken"
##Plots go here:
plotdir=file.path(procroot,"plots")

##Load libraries and sources
require(ggplot2)
require(reshape)

##read in the data
if (TRUE) {

    for (i in seq(samporder)){
        ind=samporder[i]
        samp=bismark.samp.info$label[ind]
        print(samp)
        mbias=read.delim(file=bismark.samp.info$filepath[ind],header=F,skip=3,colClasses="character")
        r1=121
        r2ind=1+(r1+3)*3
        r2=120
        cpg1=sapply(mbias[1:r1,],function(x) as.numeric(x))
        cpg2=sapply(mbias[r2ind:(r2ind+r2-1),],function(x) as.numeric(x))
                
        cpg=as.data.frame(rbind(cpg1,cpg2))
        colnames(cpg)=c("pos","countM","countUM","Mperc","cov")
        cpg$read=c(rep(times=r1,"read 1"),rep(times=r2,"read2"))
	dflist[[i]]=cpg
        
        q = ggplot(cpg,aes(x=pos,y=Mperc,group=read,color=read))+ ylim(0,100) +
            labs(title=samp,x="Sequence Position",y="Methylation Percentage")+
            geom_line(size=1.5)+theme_bw()+
            theme(legend.position="none",axis.title.x=element_blank(),axis.title.y=element_blank())
        pl[[i]]=q
        if (F){
            pdf(file.path(plotdir,paste0(samp,"_mbias.pdf")))
            print(q)
            dev.off()
        }
    }
    l=matrix(seq(1,12),ncol=3,byrow=T)
    pdf(file.path(plotdir,"mbias.pdf"))
    multiplot(plotlist=pl,layout=l)
    dev.off()
    ## just doing one plot with all data
    print(dflist)
    pos=dflist[[1]][,1]
    read=dflist[[1]][,6]
    meth=rowMeans(sapply(dflist,'[[',4))
    meandf=data.frame(pos,meth,read)
    q = ggplot(meandf,aes(x=pos,y=meth,group=read,color=read))+ylim(0,100)+
        labs(x="Sequence Position",y="Methylation Percentage") +
        geom_line(size=1)+theme_bw()
    pdf(file.path(plotdir,"mbiasmean.pdf"))
    print(q)
    dev.off()
}
